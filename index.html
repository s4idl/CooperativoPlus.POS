<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto de Venta Cooperativa</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <!-- React, ReactDOM, Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>

  <!-- Estilos Personalizados -->
  <style>
    /* 1. COLOR VERDE BOSQUE */
    :root {
      --bs-success: #198754;
      --bs-success-dark: #2A4D39;
      --bs-success-subtle: #eaf1ed;
      --bs-success-contrast: #ffffff;
    }

    .bg-success-dark { background-color: var(--bs-success-dark) !important; }
    .text-success-dark { color: var(--bs-success-dark) !important; }
    .btn-success-dark {
      background-color: var(--bs-success-dark);
      border-color: var(--bs-success-dark);
      color: var(--bs-success-contrast);
      font-weight: 600;
    }
    .btn-success-dark:hover {
      background-color: #223f2f;
      border-color: #223f2f;
      color: var(--bs-success-contrast);
    }
    .btn-outline-success-dark {
      border-color: var(--bs-success-dark);
      color: var(--bs-success-dark);
      font-weight: 600;
    }
    .btn-outline-success-dark:hover {
      background-color: var(--bs-success-dark);
      color: var(--bs-success-contrast);
    }
    .nav-tabs .nav-link.active {
       border-color: var(--bs-success-dark);
       border-bottom-color: #fff;
    }
    .text-success-contrast { color: var(--bs-success-contrast) !important; }

    /* 2. BORDES MÁS REDONDEADOS */
    .rounded-5 { border-radius: 1rem !important; }
    .card { border-radius: 1rem !important; }
    .accordion-item { border-radius: 1rem !important; border: none !important; }
    .accordion-button { border-radius: 1rem !important; }
    .modal-content { border-radius: 1rem !important; }

    /* 3. ARREGLO HEADER ACORDEÓN (SIN AZUL) */
    .accordion-button:not(.collapsed) {
        color: var(--bs-success-dark) !important;
        background-color: #fff !important;
        box-shadow: none !important;
    }
    .accordion-button:focus {
        box-shadow: none !important;
        border-color: transparent !important;
    }
    .accordion-button.collapsed { background-color: #fff !important; }

    /* Fondo principal y scroll */
    body, #root {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f8fcfb;
    }
    main { flex: 1; overflow-y: auto; }
    
    /* CORRECCIÓN CARRITO DESKTOP */
    .cart-sticky {
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 100px); 
      display: flex;
      flex-direction: column;
    }
    .cart-items-list {
      overflow-y: auto;
      flex-grow: 1; 
      flex-shrink: 1;
    }

    /* Animación de hover */
    .hover-scale-105 { transition: transform 0.2s ease-in-out; }
    .hover-scale-105:hover { transform: scale(1.05); }

    /* TICKET DE IMPRESIÓN (PÁGINA COMPLETA) */
    .print-container {
        background-color: #f8f9fa;
        padding-top: 2rem;
        padding-bottom: 2rem;
        min-height: 100vh;
    }
    .ticket-content { font-family: 'Courier New', Courier, monospace; }
    
    /* CARRITO MÓVIL PEGAJOSO */
    .cart-mobile-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      border-top: 1px solid #dee2e6;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .cart-mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
    }
    .cart-mobile-body {
      padding: 1rem;
      padding-top: 0;
      max-height: 50vh; 
      overflow-y: auto;
    }
    .cart-mobile-footer {
      padding: 1rem;
      border-top: 1px solid #eee;
    }
    .pb-mobile-cart {
       padding-bottom: 120px;
    }
    @media (min-width: 992px) { /* lg */
      .pb-mobile-cart {
        padding-bottom: 0;
      }
    }

    /* Para impresión */
    @media print {
      .no-print { display: none !important; }
      body { background: white; margin: 0; padding: 0; }
      main { display: none !important; }
      .print-container {
        padding: 0;
        background: white;
        min-height: auto;
      }
      .ticket-content { 
        margin: 0 !important; 
        box-shadow: none !important; 
        border: none !important; 
        border-radius: 0 !important;
      }
    }
  </style>
</head>
<body>

  <!-- El contenedor de React -->
  <div id="root"></div>

  <!-- Bootstrap JS (al final) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- Script de React (Babel) -->
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;
    
    const BSIcon = ({ icon, size = '1em' }) => (
      <i className={`bi bi-${icon}`} style={{ fontSize: size, lineHeight: 1 }}></i>
    );

    // --- DATOS DE EJEMPLO ---
    const PRODUCTOS = [
      { id: 101, nombre: '3 Tacos + Agua Mediana', precio: 40, categoria: 'Combos' },
      { id: 102, nombre: 'Torta + Agua Mediana', precio: 50, categoria: 'Combos' },
      { id: 201, nombre: 'Comida del Día (Guiso)', precio: 50, categoria: 'Comidas Preparadas' },
      { id: 301, nombre: 'Taco (Asada)', precio: 14, categoria: 'Comidas Individuales' },
      { id: 302, nombre: 'Taco (Adobada)', precio: 14, categoria: 'Comidas Individuales' },
      { id: 303, nombre: 'Taco (Chorizo)', precio: 14, categoria: 'Comidas Individuales' },
      { id: 304, nombre: 'Taco (Especial)', precio: 20, categoria: 'Comidas Individuales' },
      { id: 305, nombre: 'Torta (Asada)', precio: 45, categoria: 'Comidas Individuales' },
      { id: 306, nombre: 'Torta (Adobada)', precio: 45, categoria: 'Comidas Individuales' },
      { id: 307, nombre: 'Torta (Chorizo)', precio: 45, categoria: 'Comidas Individuales' },
      { id: 308, nombre: 'Torta Cubana', precio: 50, categoria: 'Comidas Individuales' },
      { id: 309, nombre: 'Mega Burrito', precio: 40, categoria: 'Comidas Individuales' },
      { id: 310, nombre: 'Quesadilla Sencilla', precio: 25, categoria: 'Comidas Individuales' },
      { id: 311, nombre: 'Quesadilla (Carne)', precio: 35, categoria: 'Comidas Individuales' },
      { id: 312, nombre: 'Sandwich', precio: 30, categoria: 'Comidas Individuales' },
      { id: 313, nombre: 'Desayuno Completo', precio: 45, categoria: 'Comidas Individuales' },
      { id: 401, nombre: 'Agua del Día (Chica)', precio: 12, categoria: 'Bebidas' },
      { id: 402, nombre: 'Agua del Día (Mediana)', precio: 18, categoria: 'Bebidas' },
      { id: 403, nombre: 'Agua del Día (Grande)', precio: 22, categoria: 'Bebidas' },
      { id: 404, nombre: 'Coca-Cola (600ml)', precio: 16, categoria: 'Bebidas' },
      { id: 405, nombre: 'Fanta (600ml)', precio: 16, categoria: 'Bebidas' },
      { id: 406, nombre: 'Sprite (600ml)', precio: 16, categoria: 'Bebidas' },
      { id: 407, nombre: 'Delaware Punch (600ml)', precio: 16, categoria: 'Bebidas' },
      { id: 408, nombre: 'Fuze Tea', precio: 16, categoria: 'Bebidas' },
      { id: 409, nombre: 'Agua Natural (600ml)', precio: 10, categoria: 'Bebidas' },
      { id: 410, nombre: 'Agua Natural (1L)', precio: 14, categoria: 'Bebidas' },
      { id: 411, nombre: 'Agua Natural (1.5L)', precio: 18, categoria: 'Bebidas' },
      { id: 412, nombre: 'Café', precio: 15, categoria: 'Bebidas' },
      { id: 413, nombre: 'Jugo Natural', precio: 20, categoria: 'Bebidas' },
      { id: 501, nombre: 'Papas (Sabritas)', precio: 15, categoria: 'Snacks' },
      { id: 502, nombre: 'Galletas', precio: 10, categoria: 'Snacks' },
      { id: 503, nombre: 'Chocolate (Carlos V)', precio: 12, categoria: 'Snacks' },
      { id: 504, nombre: 'Barra de Granola', precio: 8, categoria: 'Snacks' },
    ];
    
    const categorias = [
      'Combos', 
      'Comidas Preparadas', 
      'Comidas Individuales', 
      'Bebidas', 
      'Snacks'
    ];
    
    const foodCategories = ['Combos', 'Comidas Preparadas', 'Comidas Individuales'];

    // --- FUNCIÓN HELPER PARA FECHA ---
    const formatDate = () => {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const today = new Date();
      return today.toLocaleDateString('es-MX', options).replace(/\b\w/g, l => l.toUpperCase());
    };

    // --- COMPONENTES HIJOS ---

    // --- 1. Navegación (Navbar Superior) ---
    const Navigation = ({ pantalla, setPantalla }) => (
      <nav className="navbar navbar-expand-sm bg-success-dark navbar-dark shadow-lg sticky-top p-3 no-print">
        <div className="container-fluid">
          <a className="navbar-brand fw-bold fs-5" href="#">CooperativaPlus</a>
          <button className="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span className="navbar-toggler-icon"></span>
          </button>
          <div className="collapse navbar-collapse" id="navbarNav">
            <div className="navbar-nav ms-auto gap-2">
              <NavButton 
                icon="house-fill" 
                label="Inicio" 
                isActive={pantalla === 'home'} 
                onClick={() => setPantalla('home')} 
              />
              <NavButton 
                icon="clock-history" 
                label="Pedidos" 
                isActive={pantalla === 'pedidos'} 
                onClick={() => setPantalla('pedidos')} 
              />
              <NavButton 
                icon="archive-fill" 
                label="Historial" 
                isActive={pantalla === 'historial'} 
                onClick={() => setPantalla('historial')} 
              />
              <NavButton 
                icon="cart-plus-fill" 
                label="Nuevo Pedido" 
                isActive={pantalla === 'nuevo-pedido'} 
                onClick={() => setPantalla('nuevo-pedido')} 
              />
            </div>
          </div>
        </div>
      </nav>
    );

    const NavButton = ({ icon, label, isActive, onClick }) => (
      <button
        onClick={onClick}
        className={`btn d-flex align-items-center gap-2 fw-semibold ${
          isActive ? 'btn-success text-white' : 'btn-success-dark'
        }`}
      >
        <BSIcon icon={icon} size="1.1em" />
        <span>{label}</span>
      </button>
    );

    // --- 2. Pantalla: Home ---
    const HomePage = ({ onNuevoPedido, onVerHistorial, stats }) => {
      const { 
        pedidosActivos, 
        pedidosCompletados, 
        ventaTotal, 
        productoMasVendido 
      } = stats;

      return (
        <div className="container-lg">
          <div className="mb-4">
            <h1 className="fw-bold text-success-dark">Inicio</h1>
            <p className="fs-5 text-success-dark">{formatDate()}</p>
          </div>

          <div className="row g-4 row-cols-1 row-cols-md-2">
            <div className="col">
              <div
                onClick={onNuevoPedido}
                className="card h-100 shadow-lg border-0 text-center p-4 hover-scale-105 bg-success-dark text-white"
                style={{ cursor: 'pointer' }}
              >
                <div className="card-body d-flex flex-column align-items-center justify-content-center">
                  <BSIcon icon="cart-plus-fill" size="3em" className="text-white" />
                  <span className="fs-4 fw-bold text-white mt-3">Nuevo Pedido</span>
                  <span className="fs-6 text-white-50">Comenzar una nueva venta</span>
                </div>
              </div>
            </div>

            <div className="col">
              <div
                onClick={onVerHistorial}
                className="card h-100 shadow-lg border-2 border-success-subtle text-center p-4 hover-scale-105"
                style={{ cursor: 'pointer' }}
              >
                <div className="card-body d-flex flex-column align-items-center justify-content-center">
                  <BSIcon icon="cash-coin" size="3em" />
                  <span className="fs-4 fw-bold text-success-dark mt-3">Venta del día</span>
                  <span className="fs-3 fw-bold text-success-dark">
                    ${ventaTotal.toFixed(2)}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div className="card shadow-lg mt-5 rounded-5">
            <div className="card-body p-4">
              <h2 className="fs-4 fw-bold text-success-dark mb-4">Estadísticas rápidas</h2>
              <div className="row g-3 text-center">
                <div className="col-sm-4">
                  <div className="p-3 bg-success-subtle rounded-4 h-100 d-flex flex-column justify-content-center">
                    <p className="text-success-dark fw-semibold mb-1">Pedidos Activos</p>
                    <p className="fs-3 fw-bold text-success-dark mb-0">{pedidosActivos}</p>
                  </div>
                </div>
                <div className="col-sm-4">
                  <div className="p-3 bg-success-subtle rounded-4 h-100 d-flex flex-column justify-content-center">
                    <p className="text-success-dark fw-semibold mb-1">Pedidos completados</p>
                    <p className="fs-3 fw-bold text-success-dark mb-0">{pedidosCompletados}</p>
                  </div>
                </div>
                <div className="col-sm-4">
                  <div className="p-3 bg-success-subtle rounded-4 h-100 d-flex flex-column justify-content-center">
                    <p className="text-success-dark fw-semibold mb-1">Más vendido (Comida)</p>
                    <p className="fs-6 fw-bold text-success-dark mb-0">{productoMasVendido}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // --- 3. Pantalla: Nuevo Pedido ---
    const ProductList = ({ onAgregarProducto }) => {
      return (
        <div className="accordion" id="productAccordion">
          {categorias.map((categoria, index) => (
            <div className="accordion-item rounded-5 shadow-lg mb-3" key={categoria}>
              <h2 className="accordion-header" id={`heading-${index}`}>
                <button
                  className="accordion-button fs-5 fw-bold text-success-dark rounded-5"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target={`#collapse-${index}`}
                  aria-expanded="true"
                  aria-controls={`collapse-${index}`}
                >
                  {categoria}
                </button>
              </h2>
              <div
                id={`collapse-${index}`}
                className="accordion-collapse collapse show"
                aria-labelledby={`heading-${index}`}
                data-bs-parent="#productAccordion"
              >
                <div className="accordion-body">
                  <div className="row row-cols-2 row-cols-md-3 g-3">
                    {PRODUCTOS.filter(p => p.categoria === categoria).map(producto => (
                      <div className="col" key={producto.id}>
                        <button
                          onClick={() => onAgregarProducto(producto)}
                          className="btn btn-outline-success-dark w-100 h-100 text-start p-3 rounded-4"
                        >
                          <p className="fw-bold mb-1">{producto.nombre}</p>
                          <p className="fs-5 fw-bold text-success-dark mb-0">${producto.precio}</p>
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    };

    const Cart = ({ 
      isMobile,
      carrito, 
      observaciones, 
      setObservaciones, 
      onModificarCantidad, 
      onEliminarProducto, 
      onConfirmarPedido 
    }) => {
      const [mostrarPago, setMostrarPago] = useState(false);
      const [metodoPago, setMetodoPago] = useState('');
      const [isExpanded, setIsExpanded] = useState(false); 

      const calcularTotal = () => {
        return carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      };
      
      const total = calcularTotal();

      const handleConfirmar = () => {
        const exito = onConfirmarPedido({
          items: carrito,
          observaciones,
          total,
          metodoPago,
        });
        
        if(exito) {
          setMostrarPago(false);
          setMetodoPago('');
          setIsExpanded(false);
        }
      };

      const renderCartInternals = (isMobileView) => (
        <React.Fragment>
          {carrito.length === 0 ? (
            <p className="text-muted text-center py-5">No hay productos</p>
          ) : (
            <div className="list-group list-group-flush">
              {carrito.map(item => (
                <div className="list-group-item d-flex flex-wrap justify-content-between align-items-center gap-2" key={item.id}>
                  <div className="flex-grow-1 me-2">
                    <p className="fw-semibold text-success-dark mb-0">{item.nombre}</p>
                    <p className="text-success-dark small mb-0">${item.precio} x {item.cantidad}</p>
                  </div>
                  <div className="btn-group" role="group">
                    <button onClick={() => onModificarCantidad(item.id, -1)} className="btn btn-success-dark btn-sm"><BSIcon icon="dash" /></button>
                    <span className="btn btn-outline-secondary btn-sm disabled" style={{ width: '40px' }}>{item.cantidad}</span>
                    <button onClick={() => onModificarCantidad(item.id, 1)} className="btn btn-success-dark btn-sm"><BSIcon icon="plus" /></button>
                    <button onClick={() => onEliminarProducto(item.id)} className="btn btn-outline-danger btn-sm"><BSIcon icon="trash-fill" /></button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </React.Fragment>
      );

      const renderPaymentSection = (isMobileView) => (
         <div className="border-top pt-4 mt-auto">
            <textarea
              value={observaciones}
              onChange={(e) => setObservaciones(e.target.value)}
              placeholder="Observaciones del pedido..."
              className="form-control border-2 border-success-subtle mb-3 rounded-4"
              rows="3"
            />
            
            {(isMobileView ? isExpanded : true) && (
              <div className="d-flex justify-content-between align-items-center mb-3">
                <span className="fs-5 fw-bold text-success-dark">Total:</span>
                <span className="fs-3 fw-bold text-success-dark">${total.toFixed(2)}</span>
              </div>
            )}

            {!mostrarPago ? (
              <button
                onClick={() => carrito.length > 0 && setMostrarPago(true)}
                disabled={carrito.length === 0}
                className="btn btn-success-dark btn-lg w-100 rounded-4"
              >
                Proceder al pago
              </button>
            ) : (
              <div className="d-grid gap-2">
                <p className="fw-semibold text-success-dark mb-1">Método de pago:</p>
                <button
                  onClick={() => setMetodoPago('efectivo')}
                  className={`btn btn-lg w-100 d-flex align-items-center justify-content-center gap-2 rounded-4 ${
                    metodoPago === 'efectivo' ? 'btn-success-dark' : 'btn-outline-success-dark'
                  }`}
                >
                  <BSIcon icon="cash-coin" /> Efectivo
                </button>
                <button
                  onClick={() => setMetodoPago('tarjeta')}
                  className={`btn btn-lg w-100 d-flex align-items-center justify-content-center gap-2 rounded-4 ${
                    metodoPago === 'tarjeta' ? 'btn-success-dark' : 'btn-outline-success-dark'
                  }`}
                >
                  <BSIcon icon="credit-card-fill" /> Tarjeta
                </button>
                <button
                  onClick={handleConfirmar}
                  disabled={!metodoPago}
                  className="btn btn-success-dark btn-lg w-100 rounded-4"
                >
                  <BSIcon icon="check-lg" /> Confirmar pedido
                </button>
                <button
                  onClick={() => setMostrarPago(false)}
                  className="btn btn-secondary w-100 rounded-4"
                >
                  Cancelar
                </button>
              </div>
            )}
          </div>
      );

      // --- RENDER MÓVIL ---
      if (isMobile) {
        return (
          <div className="cart-mobile-container no-print">
            <div className="cart-mobile-header" onClick={() => setIsExpanded(!isExpanded)}>
              <span className="fw-bold text-success-dark d-flex align-items-center gap-2">
                <BSIcon icon={isExpanded ? 'chevron-down' : 'chevron-up'} />
                {isExpanded ? 'Ocultar' : 'Ver Carrito'} ({carrito.length} items)
              </span>
              <span className="fw-bold fs-5 text-success-dark">${total.toFixed(2)}</span>
            </div>

            {isExpanded && (
              <div className="cart-mobile-body">
                {renderCartInternals(true)}
                {renderPaymentSection(true)}
              </div>
            )}
            
            {!isExpanded && (
               <div className="cart-mobile-footer">
                 <button 
                   onClick={() => { setMostrarPago(true); setIsExpanded(true); }} 
                   disabled={carrito.length === 0}
                   className="btn btn-success-dark btn-lg w-100 rounded-4"
                 >
                   Proceder al pago (${total.toFixed(2)})
                 </button>
               </div>
            )}
          </div>
        );
      }

      // --- RENDER ESCRITORIO ---
      return (
        <div className="card shadow-xl rounded-5 cart-sticky">
          <div className="card-body d-flex flex-column p-4">
            <h2 className="fs-4 fw-bold text-success-dark mb-3">Carrito</h2>
            <div className="cart-items-list flex-grow-1">
              {renderCartInternals(false)}
            </div>
            {renderPaymentSection(false)}
          </div>
        </div>
      );
    };

    const NewOrderPage = ({ onAgregarPedido }) => {
      const [carrito, setCarrito] = useState([]);
      const [observaciones, setObservaciones] = useState('');

      const agregarProducto = (producto) => {
        const existe = carrito.find(item => item.id === producto.id);
        if (existe) {
          setCarrito(carrito.map(item =>
            item.id === producto.id ? { ...item, cantidad: item.cantidad + 1 } : item
          ));
        } else {
          setCarrito([...carrito, { ...producto, cantidad: 1 }]);
        }
      };

      const modificarCantidad = (id, delta) => {
        setCarrito(carrito.map(item =>
          item.id === id ? { ...item, cantidad: Math.max(0, item.cantidad + delta) } : item
        ).filter(item => item.cantidad > 0));
      };

      const eliminarProducto = (id) => {
        setCarrito(carrito.filter(item => item.id !== id));
      };

      const confirmarPedido = (pedidoData) => {
        onAgregarPedido(pedidoData);
        setCarrito([]);
        setObservaciones('');
        return true; 
      };

      return (
        <div className="container-xxl">
          <h1 className="fw-bold text-success-dark mb-4">Nuevo Pedido</h1>
          <div className="row g-4">
            <div className="col-lg-9 pb-mobile-cart">
              <ProductList onAgregarProducto={agregarProducto} />
            </div>
            <div className="col-lg-3 d-none d-lg-block">
              <Cart
                isMobile={false}
                carrito={carrito}
                observaciones={observaciones}
                setObservaciones={setObservaciones}
                onModificarCantidad={modificarCantidad}
                onEliminarProducto={eliminarProducto}
                onConfirmarPedido={confirmarPedido}
              />
            </div>
          </div>
          <div className="d-lg-none">
            <Cart
              isMobile={true}
              carrito={carrito}
              observaciones={observaciones}
              setObservaciones={setObservaciones}
              onModificarCantidad={modificarCantidad}
              onEliminarProducto={eliminarProducto}
              onConfirmarPedido={confirmarPedido}
            />
          </div>
        </div>
      );
    };

    // --- 4. Pantalla: Pedidos Activos ---
    const ActiveOrdersPage = ({ pedidos, onActualizarEstadoPedido, onPrintTicket }) => {
      const [filtroId, setFiltroId] = useState('');
      
      const pedidosActivos = pedidos.filter(p => p.estado === 'Pendiente');

      const pedidosFiltrados = pedidosActivos.filter(p => 
        p.id.toString().includes(filtroId)
      );

      pedidosFiltrados.sort((a, b) => a.id - b.id); 

      return (
        <div className="container-lg">
          <div className="mb-4 row justify-content-between align-items-center g-3">
            <div className="col-md-6">
              <h1 className="fw-bold text-success-dark mb-0">Pedidos Activos</h1>
            </div>
            <div className="col-md-5 col-lg-4">
              <div className="input-group">
                <span className="input-group-text rounded-start-4"><BSIcon icon="search" /></span>
                <input 
                  type="text" 
                  placeholder="Buscar por ID..."
                  value={filtroId}
                  onChange={(e) => setFiltroId(e.target.value)}
                  className="form-control form-control-lg border-2 border-success-subtle rounded-end-4"
                />
              </div>
            </div>
          </div>

          <div className="d-flex flex-column gap-4">
            {pedidosFiltrados.length === 0 ? (
              <div className="card shadow-lg p-5 text-center rounded-5">
                <BSIcon icon="clock-history" size="4em" className="text-muted mb-3" />
                <p className="text-muted fs-4">
                  {filtroId ? 'No se encontraron pedidos' : 'No hay pedidos pendientes'}
                </p>
              </div>
            ) : (
              pedidosFiltrados.map(pedido => (
                <PedidoCard 
                  key={pedido.id} 
                  pedido={pedido} 
                  onActualizarEstado={onActualizarEstadoPedido} 
                  onPrintTicket={onPrintTicket}
                />
              ))
            )}
          </div>
        </div>
      );
    };

    // --- 5. Pantalla: Historial (MODIFICADA) ---
    const HistorialPage = ({ pedidos, onActualizarEstadoPedido, onPrintTicket, onReiniciarDia }) => {
      const [filtro, setFiltro] = useState('todos');

      const pedidosFiltrados = (filtro === 'todos'
        ? pedidos 
        : pedidos.filter(p => p.estado.toLowerCase() === filtro)
      ).sort((a, b) => b.id - a.id); 

      const totalVentas = pedidos.filter(p => p.estado === 'Entregado').reduce((sum, p) => sum + p.total, 0);
      const ventasEfectivo = pedidos.filter(p => p.metodoPago === 'efectivo' && p.estado === 'Entregado').reduce((sum, p) => sum + p.total, 0);
      const ventasTarjeta = pedidos.filter(p => p.metodoPago === 'tarjeta' && p.estado === 'Entregado').reduce((sum, p) => sum + p.total, 0);
      const totalCancelados = pedidos.filter(p => p.estado === 'Cancelado').length;

      return (
        <div className="container-xl">
          <h1 className="fw-bold text-success-dark mb-4">Historial</h1>

          {/* Estadísticas */}
          <div className="row g-4 row-cols-1 row-cols-md-2 row-cols-lg-4 mb-4">
            <div className="col"><StatCard label="Total de ventas" value={`$${totalVentas.toFixed(2)}`} /></div>
            <div className="col"><StatCard label="Ventas en efectivo" value={`$${ventasEfectivo.toFixed(2)}`} /></div>
            <div className="col"><StatCard label="Ventas con tarjeta" value={`$${ventasTarjeta.toFixed(2)}`} /></div>
            <div className="col"><StatCard label="Cancelados" value={totalCancelados} /></div>
          </div>

          {/* Filtros */}
          <div className="card shadow-lg p-4 mb-4 rounded-5">
            <p className="fw-semibold text-success-dark mb-2">Filtrar por estado:</p>
            <div className="d-flex flex-wrap gap-2">
              {['todos', 'pendiente', 'entregado', 'cancelado'].map(estado => (
                <button
                  key={estado}
                  onClick={() => setFiltro(estado)}
                  className={`btn fw-semibold rounded-pill ${
                    filtro === estado ? 'btn-success-dark' : 'btn-outline-secondary'
                  }`}
                >
                  {estado.charAt(0).toUpperCase() + estado.slice(1)}
                </button>
              ))}
            </div>
          </div>

          {/* Lista de Pedidos */}
          <div className="d-flex flex-column gap-4">
            {pedidosFiltrados.length === 0 ? (
              <div className="card shadow-lg p-5 text-center rounded-5">
                <BSIcon icon="archive-fill" size="4em" className="text-muted mb-3" />
                <p className="text-muted fs-4">No hay pedidos para mostrar</p>
              </div>
            ) : (
              pedidosFiltrados.map(pedido => (
                <PedidoCard 
                  key={pedido.id} 
                  pedido={pedido} 
                  onActualizarEstado={onActualizarEstadoPedido} 
                  onPrintTicket={onPrintTicket}
                />
              ))
            )}
          </div>
          
          {/* Zona de Peligro (MOVIDA AL FINAL) */}
          <div className="card shadow-lg p-4 mt-5 rounded-5 border-danger-subtle">
            <p className="fw-semibold text-danger mb-2">Zona de Peligro</p>
            <button
              onClick={onReiniciarDia}
              className="btn btn-outline-danger d-flex align-items-center justify-content-center gap-2 rounded-pill"
            >
              <BSIcon icon="exclamation-triangle-fill" />
              Reiniciar Día (Borrar Todo)
            </button>
          </div>
          
        </div>
      );
    };

    const StatCard = ({ label, value }) => (
      <div className="card h-100 shadow-lg border-2 border-success-subtle rounded-5">
        <div className="card-body p-4 d-flex flex-column justify-content-center">
          <p className="text-success-dark fw-semibold mb-1">{label}</p>
          <p className="fs-3 fw-bold text-success-dark mb-0">{value}</p>
        </div>
      </div>
    );

    const PedidoCard = ({ pedido, onActualizarEstado, onPrintTicket }) => {
      let statusClass = 'text-bg-warning';
      if (pedido.estado === 'Entregado') statusClass = 'text-bg-primary';
      if (pedido.estado === 'Cancelado') statusClass = 'text-bg-danger';

      return (
        <div className="card shadow-lg rounded-5">
          <div className="card-body p-4">
            <div className="row g-3 justify-content-between">
              <div className="col-md-5">
                <p className="text-muted small mb-0">Pedido #{pedido.id}</p>
                <p className="text-muted small mb-2">{pedido.fecha}</p>
                <span className={`badge rounded-pill fs-6 ${statusClass}`}>
                  {pedido.estado}
                </span>
              </div>
              <div className="col-md-5 text-md-end">
                <p className="fs-3 fw-bold text-success-dark mb-1">${pedido.total.toFixed(2)}</p>
                <p className="text-muted text-capitalize">
                  {pedido.metodoPago === 'efectivo' ? <BSIcon icon="cash-coin" /> : <BSIcon icon="credit-card-fill" />}
                  {' '}{pedido.metodoPago}
                </p>
                <button 
                  onClick={() => onPrintTicket(pedido)}
                  className="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2 ms-md-auto rounded-pill"
                >
                  <BSIcon icon="printer-fill" /> Imprimir Ticket
                </button>
              </div>
            </div>

            <hr />

            <div className="mb-3">
              <p className="fw-semibold text-success-dark mb-2">Productos:</p>
              <ul className="list-group list-group-flush">
                {pedido.items.map((item, idx) => (
                  <li key={idx} className="list-group-item d-flex justify-content-between">
                    <span>{item.cantidad}x {item.nombre}</span>
                    <span className="fw-medium">${(item.precio * item.cantidad).toFixed(2)}</span>
                  </li>
                ))}
              </ul>
              {pedido.observaciones && (
                <div className="mt-3 p-3 bg-success-subtle rounded-4">
                  <p className="fw-semibold text-success-dark small mb-0">Observaciones:</p>
                  <p className="text-success-dark mb-0">{pedido.observaciones}</p>
                </div>
              )}
            </div>

            {pedido.estado === 'Pendiente' && (
              <div className="d-flex flex-column flex-sm-row gap-2">
                <button
                  onClick={() => onActualizarEstado(pedido.id, 'Cancelado')}
                  className="btn btn-danger btn-lg flex-grow-1 d-flex align-items-center justify-content-center gap-2 rounded-4"
                >
                  <BSIcon icon="x-lg" /> Cancelar
                </button>
                <button
                  onClick={() => onActualizarEstado(pedido.id, 'Entregado')}
                  className="btn btn-success-dark btn-lg flex-grow-1 d-flex align-items-center justify-content-center gap-2 rounded-4"
                >
                  <BSIcon icon="check-lg" /> Marcar entregado
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    // --- 6. TICKET DE IMPRESIÓN (PÁGINA COMPLETA) ---
    const TicketPage = ({ pedido, onClose }) => {
      return (
        <div className="print-container no-print">
          <div className="card shadow-lg rounded-5 mx-auto ticket-content" style={{ maxWidth: '320px' }}>
            <div className="card-body p-4">
              <h2 className="text-center fs-5 fw-bold mb-3">CooperativaPlus</h2>
              <p className="text-center small text-muted">Ticket de Pedido</p>
              <p className="text-center small text-muted mb-3">--------------------------------</p>
              <p className="mb-0"><span className="fw-bold">Pedido:</span> #{pedido.id}</p>
              <p className="mb-0 small"><span className="fw-bold">Fecha:</span> {pedido.fecha}</p>
              <p className="mb-3"><span className="fw-bold">Estado:</span> {pedido.estado}</p>
              
              <p className="fw-bold border-top border-bottom py-1 mb-2">Productos:</p>
              <ul className="list-unstyled my-2">
                {pedido.items.map((item, idx) => (
                  <li key={idx} className="d-flex justify-content-between small">
                    <span>{item.cantidad}x {item.nombre}</span>
                    <span>${(item.precio * item.cantidad).toFixed(2)}</span>
                  </li>
))}
              </ul>
              
              {pedido.observaciones && (
                <div className="small mt-2 border-top pt-2">
                  <p className="fw-bold mb-0">Obs:</p>
                  <p className="mb-0">{pedido.observaciones}</p>
                </div>
              )}

              <div className="border-top border-2 border-dark border-dashed mt-3 pt-2">
                <p className="d-flex justify-content-between fs-6 fw-bold">
                  <span>Total:</span>
                  <span>${(pedido.total).toFixed(2)}</span>
                </p>
                <p className="small text-capitalize mb-0"><span className="fw-bold">Pago:</span> {pedido.metodoPago}</p>
              </div>
              <p className="text-center small mt-3 mb-0">¡Gracias por su compra!</p>
            </div>
          </div>
          
          <div className="mx-auto mt-4 d-flex gap-3" style={{ maxWidth: '320px' }}>
            <button onClick={onClose} className="btn btn-danger btn-lg flex-grow-1 rounded-pill">
              Cerrar
            </button>
            <button onClick={() => window.print()} className="btn btn-success-dark btn-lg flex-grow-1 rounded-pill">
              Imprimir
            </button>
          </div>
        </div>
      );
    };

    // --- MODAL DE CONFIRMACIÓN ---
    const ReiniciarModal = ({ show, onHide, onConfirm }) => {
      const modalRef = useRef();
      const [modalInstance, setModalInstance] = useState(null);

      useEffect(() => {
        if (modalRef.current) {
          const bsModal = new bootstrap.Modal(modalRef.current, {
            keyboard: false,
            backdrop: 'static'
          });
          setModalInstance(bsModal);
        }
      }, []);

      useEffect(() => {
        if (modalInstance) {
          if (show) {
            modalInstance.show();
          } else {
            modalInstance.hide();
          }
        }
      }, [show, modalInstance]);

      return (
        <div className="modal fade no-print" ref={modalRef} tabIndex="-1" id="resetModal">
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content rounded-5">
              <div className="modal-header bg-danger text-white">
                <h5 className="modal-title fw-bold">Confirmar Reinicio</h5>
                <button type="button" className="btn-close btn-close-white" onClick={onHide}></button>
              </div>
              <div className="modal-body">
                <p className="fs-5">¿Estás seguro de que deseas borrar todo el historial?</p>
                <p className="text-muted">Esta acción no se puede deshacer y reiniciará el contador de pedidos a 100.</p>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-secondary rounded-pill" onClick={onHide}>Cancelar</button>
                <button type="button" className="btn btn-danger rounded-pill" onClick={onConfirm}>
                  <BSIcon icon="trash3-fill" /> Sí, borrar todo
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };


    // --- COMPONENTE PRINCIPAL: App ---
    function App() {
      const [pantalla, setPantalla] = useState('home');
      const [pedidos, setPedidos] = useState([]);
      const [orderCounter, setOrderCounter] = useState(100);
      const [printingPedido, setPrintingPedido] = useState(null);
      const [showResetModal, setShowResetModal] = useState(false); 

      const agregarPedido = (pedidoData) => {
        const nuevoPedido = {
          ...pedidoData,
          id: orderCounter,
          fecha: new Date().toLocaleString('es-MX'),
          estado: 'Pendiente'
        };
        setPedidos(prevPedidos => [...prevPedidos, nuevoPedido]);
        setOrderCounter(prevCounter => prevCounter + 1);
        setPantalla('pedidos');
        return true; 
      };

      const actualizarEstadoPedido = (id, nuevoEstado) => {
        setPedidos(pedidos.map(p => p.id === id ? { ...p, estado: nuevoEstado } : p));
      };

      const reiniciarDia = () => {
        setPedidos([]);
        setOrderCounter(100);
        setPrintingPedido(null);
        setShowResetModal(false); 
      };

      const stats = useMemo(() => {
        const pedidosCompletados = pedidos.filter(p => p.estado === 'Entregado');
        const ventaTotal = pedidosCompletados.reduce((sum, p) => sum + p.total, 0);
        
        const itemCounts = {};
        pedidosCompletados.forEach(pedido => {
          pedido.items.forEach(item => {
            const productoInfo = PRODUCTOS.find(p => p.id === item.id);
            if (productoInfo && foodCategories.includes(productoInfo.categoria)) {
              itemCounts[item.nombre] = (itemCounts[item.nombre] || 0) + item.cantidad;
            }
          });
        });

        let productoMasVendido = 'N/A';
        let maxCount = 0;
        for (const [nombre, count] of Object.entries(itemCounts)) {
          if (count > maxCount) {
            maxCount = count;
            productoMasVendido = nombre;
          }
        }

        return {
          pedidosActivos: pedidos.filter(p => p.estado === 'Pendiente').length,
          pedidosCompletados: pedidosCompletados.length,
          ventaTotal,
          productoMasVendido,
        };
      }, [pedidos]);

      const renderPantalla = () => {
        switch (pantalla) {
          case 'home':
            return <HomePage
              onNuevoPedido={() => setPantalla('nuevo-pedido')}
              onVerHistorial={() => setPantalla('historial')}
              stats={stats}
            />;
          case 'pedidos':
            return <ActiveOrdersPage
              pedidos={pedidos}
              onActualizarEstadoPedido={actualizarEstadoPedido}
              onPrintTicket={setPrintingPedido}
            />;
          case 'historial':
            return <HistorialPage
              pedidos={pedidos}
              onActualizarEstadoPedido={actualizarEstadoPedido}
              onPrintTicket={setPrintingPedido}
              onReiniciarDia={() => setShowResetModal(true)} 
            />;
          case 'nuevo-pedido':
            return <NewOrderPage
              onAgregarPedido={agregarPedido}
            />;
          default:
            return <HomePage />;
        }
      };
      
      if (printingPedido) {
        return <TicketPage pedido={printingPedido} onClose={() => setPrintingPedido(null)} />;
      }

      return (
        <React.Fragment>
          <Navigation pantalla={pantalla} setPantalla={setPantalla} />
          <main className="container-fluid p-3 p-md-4 no-print">
            {renderPantalla()}
          </main>
          <ReiniciarModal 
            show={showResetModal}
            onHide={() => setShowResetModal(false)}
            onConfirm={reiniciarDia}
          />
        </React.Fragment>
      );
    }

    // --- Montar la aplicación ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
  
</body>
</html>